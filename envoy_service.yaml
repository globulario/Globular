[Unit]
Description=Globular Envoy Proxy
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=globular
Group=globular

# Ensure ExecStartPre runs as root even with User=globular.
PermissionsStartOnly=true

# Persist low-port binding capability on the binary each start.
ExecStartPre=/usr/sbin/setcap cap_net_bind_service=+ep /usr/lib/globular/bin/envoy

# Allow binding to :80 / :443 while staying non-root.
AmbientCapabilities=CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE

# Keep NoNewPrivileges enabled; setcap + ambient caps handle binding.
NoNewPrivileges=true

ExecStartPre=/bin/sh -c 'set -e; echo "[globular-envoy] verifying CAP_NET_BIND_SERVICE..."; \
  /usr/bin/getcap /usr/lib/globular/bin/envoy || true; \
  true'

ExecStart=/usr/lib/globular/bin/envoy -c /etc/globular/envoy/envoy.yaml
Restart=always
RestartSec=2
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
