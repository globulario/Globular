#-- Docker install. --
FROM ubuntu
RUN apt-get update && apt-get install -y gnupg2 \
    wget curl \
  && rm -rf /var/lib/apt/lists/*
RUN curl -fsSL https://pgp.mongodb.com/server-6.0.asc | \
    gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg \
   --dearmor
RUN echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list

ENV TZ=Asia/Kolkata \
    DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
  build-essential \
  nano \
  python3 \
  python-is-python3 \
  mongodb-org

ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Moscow
RUN apt-get install -y ffmpeg

# -- Install prometheus
RUN wget https://github.com/prometheus/prometheus/releases/download/v2.23.0/prometheus-2.23.0.linux-armv7.tar.gz
RUN tar -xf prometheus-2.23.0.linux-armv7.tar.gz
RUN cp prometheus-2.23.0.linux-armv7/prometheus /usr/local/bin/
RUN cp prometheus-2.23.0.linux-armv7/promtool /usr/local/bin/
RUN cp -r prometheus-2.23.0.linux-armv7/consoles /etc/prometheus/
RUN cp -r prometheus-2.23.0.linux-armv7/console_libraries /etc/prometheus/
RUN rm -rf prometheus-2.23.0.linux-armv7*

# -- Install alert manager
RUN wget https://github.com/prometheus/alertmanager/releases/download/v0.21.0/alertmanager-0.21.0.linux-armv7.tar.gz
RUN tar -xf alertmanager-0.21.0.linux-armv7.tar.gz
RUN cp alertmanager-0.21.0.linux-armv7/alertmanager /usr/local/bin
RUN rm -rf alertmanager-0.21.0.linux-armv7*

# -- Install node exporter
RUN wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-armv7.tar.gz
RUN tar -xf node_exporter-1.0.1.linux-armv7.tar.gz
RUN cp node_exporter-1.0.1.linux-armv7/node_exporter /usr/local/bin
RUN rm -rf node_exporter-1.0.1.linux-armv7*

# -- Install unix odbc drivers.
RUN curl https://www.unixodbc.org/unixODBC-2.3.11.tar.gz --output unixODBC-2.3.11.tar.gz
RUN tar -xvf unixODBC-2.3.11.tar.gz
RUN rm unixODBC-2.3.11.tar.gz
WORKDIR unixODBC-2.3.11
RUN ./configure && make all install clean && ldconfig

# -- Install zlib
RUN curl  https://zlib.net/zlib-1.2.13.tar.gz --output zlib-1.2.13.tar.gz
RUN tar -xvf zlib-1.2.13.tar.gz
RUN rm zlib-1.2.13.tar.gz
WORKDIR zlib-1.2.13
RUN ./configure && make all install clean && ldconfig

# -- Install yt-dlp
RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp  --output /usr/local/bin/yt-dlp
RUN chmod a+rx /usr/local/bin/yt-dlp

# -- Copy globular files.
RUN mkdir /usr/local/share/globular
RUN mkdir /etc/globular
RUN mkdir /etc/globular/config
RUN mkdir /var/globular
RUN mkdir /var/globular/data
RUN mkdir /var/globular/webroot
ADD Globular /usr/local/share/globular
COPY bin /usr/local/share/globular/bin
COPY services /usr/local/share/globular/services
WORKDIR /usr/local/share/globular
ENV PATH="/usr/local/share/globular/bin:${PATH}"
ENTRYPOINT ["/usr/local/share/globular/Globular"]